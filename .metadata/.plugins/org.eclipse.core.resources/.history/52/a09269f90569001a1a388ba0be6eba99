/*
 * generated by Xtext 2.20.0
 */
package dk.klevang.generator

import dk.klevang.mathInterpreter.Exp
import dk.klevang.mathInterpreter.MathExp
import dk.klevang.mathInterpreter.Minus
import dk.klevang.mathInterpreter.Plus
import dk.klevang.mathInterpreter.Mult
import dk.klevang.mathInterpreter.Div

import javax.swing.JOptionPane
import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext


/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class MathInterpreterGenerator extends AbstractGenerator {

	override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {
		val math = resource.allContents.filter(MathExp).next
		val result = math.compute
		//System.out.println("Math expression = "+math.display)
		// For +1 score, replace with hovering, see Bettini Chapter 8
		JOptionPane.showMessageDialog(null, "result = "+result,"Math Language", JOptionPane.INFORMATION_MESSAGE)
	}
	
	//
	// Compute function: computes value of expression
	// Note: written according to illegal left-recursive grammar, requires fix
	//
	
	def int compute(MathExp math) {
		System.out.println("TopExp")
		System.out.println(math.exp)
		math.exp.computeExp
	}
	
	def int computeExp(Exp exp) {
		val right = exp.right.computeNumber
		//System.out.println(exp)
		switch exp {
			Plus: right+exp.left.computeExp
			Minus: right-exp.left.computeExp
			Mult: right*exp.left.computeExp
			Div: right/exp.left.computeExp
			default: exp.left.computeNumber
		}
	}
	
//	def int computePrim(Primary factor) {
//		System.out.println(factor)
//		
//		switch factor {
//			Number: factor.getValue()
//			Parenthesis: factor.getExp().computeExp
//			default: -1000
//		}
//	}

	def int computeNumber(Exp exp)
	{
		if (exp !== null)
		{
			System.out.println(exp)
			return exp.getValue()
		}
		return 0
		
	}

	//
	// Display function: show complete syntax tree
	// NAte: written according to illegal left-recursive grammar, requires fix
	//

	//def CharSequence display(MathExp math) '''Math[쳋ath.exp.displayExp]'''
	//def CharSequence displayExp(Exp exp) '''Exp[첿xp.left.displayPrim,첿xp.operator?.displayOp,첿xp.right?.displayExp]'''
	def dispatch String displayOp(Plus op)  { "+" }
	def dispatch String displayOp(Minus op) { "-" }
	def dispatch String displayOp(Mult op) { "*" }
	def dispatch String displayOp(Div op) { "/" }
//	def CharSequence displayFactor(Primary primary) { "?" }
//	def displayPrim(Primary factor)
//	{
//		switch factor {
//			Number: factor.getValue
//			Parenthesis: factor.getExp().displayExp()
//		}
//	}
	

}
